<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë§Œ ì•„ë‹ˆë©´ ë¼ - ì‚¬ë‹¤ë¦¬ ê²Œì„</title>
    <style>
        :root {
            --primary-color: #3b82f6;
            --danger-color: #ef4444;
            --success-color: #10b981;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
        }

        * {
            box-sizing: border-box;
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
        }

        body {
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            color: var(--text-main);
            margin-bottom: 10px;
            font-size: 2rem;
            text-align: center;
        }

        .subtitle {
            color: #6b7280;
            margin-bottom: 30px;
            text-align: center;
        }

        .card {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px;
            transition: all 0.3s ease;
        }

        /* Setup Section */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        input[type="number"], select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .radio-group {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-weight: normal;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
            margin-bottom: 10px;
        }

        .btn:hover {
            filter: brightness(90%);
        }

        .btn.secondary {
            background-color: #6b7280;
        }

        /* Game Section */
        #gameSection {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            overflow-x: auto; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš© */
        }

        .ladder-container {
            position: relative;
            margin: 20px 0;
            padding: 20px 0;
            background: white;
            border-radius: 8px;
            min-width: 100%;
            text-align: center;
        }

        .inputs-row {
            display: flex;
            justify-content: center; /* ì¤‘ì•™ ì •ë ¬ */
            margin-bottom: 10px;
            width: max-content; /* ë‚´ìš©ë¬¼ë§Œí¼ ë„ˆë¹„ í™•ë³´ */
            min-width: 100%;
            padding: 0 20px;
        }

        .player-input-group, .result-input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 70px; /* ê° ë¼ì¸ ë„ˆë¹„ */
            flex-shrink: 0;
        }

        .player-input-group input, .result-input-group input {
            width: 90%;
            padding: 5px;
            text-align: center;
            font-size: 0.9rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .result-input-group input {
            background-color: #f9fafb;
            font-weight: bold;
            color: var(--danger-color);
            font-size: 0.8rem;
        }

        canvas {
            display: block;
            margin: 0 auto;
            border-top: 3px solid #333;
            border-bottom: 3px solid #333;
            cursor: pointer;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #eee;
            font-size: 1.1rem;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .winner {
            color: var(--success-color);
            font-weight: bold;
        }

        .loser {
            color: var(--danger-color);
            font-weight: bold;
        }
        
        .hidden {
            display: none;
        }
        
        .unit-info {
            background-color: #e0f2fe;
            color: #0369a1;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            text-align: center;
        }

    </style>
</head>
<body>

    <h1>ğŸªœ ë‚˜ë§Œ ì•„ë‹ˆë©´ ë¼</h1>
    <p class="subtitle">1000ì›, 500ì› ë‹¨ìœ„ê¹Œì§€ ê¹”ë”í•˜ê²Œ!</p>

    <!-- Setup Section -->
    <div id="setupCard" class="card">
        <div class="form-group">
            <label>ì°¸ê°€ ì¸ì› (ëª…)</label>
            <input type="number" id="playerCount" value="4" min="2" max="20">
        </div>

        <div class="form-group">
            <label>ì´ ê¸ˆì•¡ (ì›)</label>
            <input type="number" id="totalAmount" value="20000" step="100">
            <p style="font-size: 0.8rem; color: #666; margin-top: 5px;">* ê¸ˆì•¡ì— ë”°ë¼ 1000ì›, 500ì›, 100ì› ë‹¨ìœ„ë¡œ ìë™ ì¡°ì •ë©ë‹ˆë‹¤.</p>
        </div>

        <div class="form-group">
            <label>ê¸ˆì•¡ ë¶„ë°° ë°©ì‹</label>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="moneyMode" value="random" checked onchange="toggleDifficulty(true)"> ëœë¤ ë¶„ë°°
                </label>
                <label class="radio-label">
                    <input type="radio" name="moneyMode" value="manual" onchange="toggleDifficulty(false)"> ì§ì ‘ ì…ë ¥
                </label>
            </div>
        </div>

        <div id="difficultySection" class="form-group">
            <label>ë³µë¶ˆë³µ ê°•ë„</label>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="difficulty" value="mild" checked> ì•½í•¨ (ë¹„ìŠ·í•˜ê²Œ Në¹µ)
                </label>
                <label class="radio-label">
                    <input type="radio" name="difficulty" value="severe"> ê°•í•¨ (1ëª… ê³µì§œ + ëª°ì•„ì£¼ê¸°)
                </label>
            </div>
        </div>

        <button class="btn" onclick="initGame()">ì‚¬ë‹¤ë¦¬ ì„¸íŒ…í•˜ê¸°</button>
    </div>

    <!-- Game Section -->
    <div id="gameSection" class="card">
        <div id="unitInfoDisplay" class="unit-info"></div>

        <div class="ladder-container">
            <!-- Names Top -->
            <div id="topInputs" class="inputs-row"></div>
            
            <!-- Canvas -->
            <canvas id="ladderCanvas"></canvas>
            
            <!-- Results Bottom -->
            <div id="bottomInputs" class="inputs-row"></div>
        </div>

        <div style="width: 100%; max-width: 400px; display: flex; gap: 10px; margin: 0 auto;">
            <button class="btn" onclick="startLadder()">ì‹œì‘ (ê²°ê³¼ í™•ì¸)</button>
            <button class="btn secondary" onclick="resetToSetup()">ë‹¤ì‹œ í•˜ê¸°</button>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="resultModal" class="modal-overlay">
        <div class="modal">
            <h2 style="text-align: center;">ğŸ‰ ìµœì¢… ê²°ê³¼ ğŸ‰</h2>
            <div id="resultList"></div>
            <button class="btn" style="margin-top: 20px;" onclick="closeModal()">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let ctx;
        let canvas;
        let results = [];
        let bridges = []; // { col, y }
        let numPlayers = 0;
        let columnWidth = 70; // ê° ì„¸ë¡œì¤„ ê°„ê²©
        let startY = 20;
        let endY = 400; // ì‚¬ë‹¤ë¦¬ ë†’ì´
        let isAnimating = false;
        
        // ì´ì „ í”Œë ˆì´ì–´ ì´ë¦„ì„ ê¸°ì–µí•˜ê¸° ìœ„í•œ ë°°ì—´
        let storedNames = []; 
        let lastPlayerCount = 0;

        // ì´ˆê¸°í™” ë° DOM ë¡œë“œ
        window.onload = function() {
            canvas = document.getElementById('ladderCanvas');
            ctx = canvas.getContext('2d');
        };

        function toggleDifficulty(show) {
            const div = document.getElementById('difficultySection');
            if (show) div.classList.remove('hidden');
            else div.classList.add('hidden');
        }

        // ê²Œì„ ì´ˆê¸°í™” ë° í™”ë©´ ì „í™˜
        function initGame() {
            // ì…ë ¥ê°’ íŒŒì‹±
            numPlayers = parseInt(document.getElementById('playerCount').value);
            const totalAmount = parseInt(document.getElementById('totalAmount').value);

            // ìœ íš¨ì„± ê²€ì‚¬
            if (isNaN(numPlayers) || numPlayers < 2) {
                alert("ìµœì†Œ 2ëª… ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }
            if (isNaN(totalAmount) || totalAmount <= 0) {
                alert("ì´ ê¸ˆì•¡ì„ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            // ë‹¨ìœ„ ê³„ì‚°
            const unit = calculateUnit(totalAmount);
            document.getElementById('unitInfoDisplay').innerText = `ì´ ${totalAmount.toLocaleString()}ì› / ìµœì†Œ ë‹¨ìœ„: ${unit}ì›`;

            // UI ì „í™˜
            document.getElementById('setupCard').style.display = 'none';
            document.getElementById('gameSection').style.display = 'flex';

            // ë°ì´í„° ì¤€ë¹„
            prepareInputs(numPlayers, totalAmount, unit);
            
            // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì • (ë™ì  ë„ˆë¹„)
            // ì¢Œìš° ì—¬ë°±ì„ ìœ„í•´ ì•½ê°„ ë” í¬ê²Œ ì¡ìŒ
            const requiredWidth = (numPlayers * columnWidth) + columnWidth; 
            canvas.width = requiredWidth;
            canvas.height = endY + 40; 
            
            // ì‚¬ë‹¤ë¦¬ ì´ˆê¸°í™”: ê°€ë¡œì¤„ ì—†ì´ ì„¸ë¡œì¤„ë§Œ ê·¸ë¦¬ê¸°
            bridges = [];
            drawLadder();
        }

        // ë‹¨ìœ„ ê³„ì‚° í•¨ìˆ˜
        function calculateUnit(amount) {
            if (amount % 1000 === 0) return 1000;
            if (amount % 500 === 0) return 500;
            return 100;
        }

        // ì…ë ¥ì°½ ë° ê²°ê³¼ê°’ ìƒì„±
        function prepareInputs(count, total, unit) {
            const topDiv = document.getElementById('topInputs');
            const bottomDiv = document.getElementById('bottomInputs');
            
            // ì´ë¦„ ì…ë ¥ì°½ ë³´ì¡´ ë¡œì§
            // ê¸°ì¡´ì— ì…ë ¥ëœ ê°’ì´ ìˆê³ , ì‚¬ëŒ ìˆ˜ê°€ ê°™ë‹¤ë©´ ê°’ì„ ìœ ì§€í•¨
            const currentNameInputs = topDiv.querySelectorAll('input');
            let tempNames = [];
            if (currentNameInputs.length === count) {
                currentNameInputs.forEach(input => tempNames.push(input.value));
            }

            topDiv.innerHTML = '';
            bottomDiv.innerHTML = '';

            // ìƒë‹¨ ì´ë¦„ ì…ë ¥ì°½ ìƒì„±
            for (let i = 0; i < count; i++) {
                const group = document.createElement('div');
                group.className = 'player-input-group';
                group.style.width = `${columnWidth}px`;
                
                const input = document.createElement('input');
                input.type = 'text';
                
                // ë³´ì¡´ëœ ì´ë¦„ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì•„ë‹ˆë©´ ê¸°ë³¸ê°’
                if (tempNames.length > 0) {
                    input.value = tempNames[i];
                } else if (storedNames.length > i && lastPlayerCount === count) {
                     input.value = storedNames[i];
                } else {
                    input.value = `ì°¸ê°€ì${i + 1}`;
                }

                input.id = `name-${i}`;
                
                group.appendChild(input);
                topDiv.appendChild(group);
            }

            // í•˜ë‹¨ ê²°ê³¼(ê¸ˆì•¡) ì„¤ì •
            const mode = document.querySelector('input[name="moneyMode"]:checked').value;
            let moneyDistribution = [];

            if (mode === 'random') {
                const difficulty = document.querySelector('input[name="difficulty"]:checked').value;
                moneyDistribution = distributeMoney(count, total, difficulty, unit);
            } else {
                for(let i=0; i<count; i++) moneyDistribution.push(0);
            }

            // ê²°ê³¼ê°’ ìœ„ì¹˜ ì„ê¸°
            if (mode === 'random') {
                moneyDistribution.sort(() => Math.random() - 0.5);
            }

            // í•˜ë‹¨ ì…ë ¥ì°½ ìƒì„±
            for (let i = 0; i < count; i++) {
                const group = document.createElement('div');
                group.className = 'result-input-group';
                group.style.width = `${columnWidth}px`;

                const input = document.createElement('input');
                input.type = (mode === 'manual') ? 'number' : 'text';
                input.id = `result-${i}`;
                
                if (mode === 'random') {
                    input.value = moneyDistribution[i].toLocaleString();
                    input.readOnly = true;
                } else {
                    input.placeholder = "ê¸ˆì•¡";
                }

                group.appendChild(input);
                bottomDiv.appendChild(group);
            }
            
            // í˜„ì¬ ìƒíƒœ ì €ì¥ (ë‹¤ì‹œí•˜ê¸°ë¥¼ ìœ„í•´)
            lastPlayerCount = count;
        }

        // ê¸ˆì•¡ ë¶„ë°° ë¡œì§ (ë‹¨ìœ„ ì ìš©)
        function distributeMoney(count, total, difficulty, unit) {
            // ëª¨ë“  ê³„ì‚°ì€ 'ë‹¨ìœ„(Unit)' ê°œìˆ˜ë¡œ ë³€í™˜í•˜ì—¬ ìˆ˜í–‰
            // ì˜ˆ: 20000ì›, ë‹¨ìœ„ 1000 -> ì´ 20í¬ì¸íŠ¸
            const totalPoints = total / unit;
            let points = new Array(count).fill(0);
            
            if (difficulty === 'severe') {
                // ê°•í•¨: 1ëª…ì€ ë¬´ì¡°ê±´ 0ì›. ë‚˜ë¨¸ì§€ëŠ” ëœë¤ ë¶„ë°°
                // 1. 0ì›ì¸ ì‚¬ëŒ ì œì™¸í•œ ì¸ì›
                const payers = count - 1;
                
                // 2. ëœë¤ í¬ì¸íŠ¸ ìƒì„±
                let randoms = [];
                for(let i=0; i<payers; i++) randoms.push(Math.random());
                const sumRandom = randoms.reduce((a, b) => a + b, 0);
                
                // 3. ë¹„ìœ¨ëŒ€ë¡œ ë¶„ë°°
                let currentSum = 0;
                let distributedPoints = randoms.map(r => {
                    let p = Math.floor((r / sumRandom) * totalPoints);
                    currentSum += p;
                    return p;
                });
                
                // 4. ì”ì—¬ í¬ì¸íŠ¸ ì²˜ë¦¬ (ê°€ì¥ ë§ì´ ë‚¼ ì‚¬ëŒ í˜¹ì€ ë§ˆì§€ë§‰ ì‚¬ëŒì—ê²Œ ëª°ì•„ì£¼ê¸°)
                let remainder = totalPoints - currentSum;
                distributedPoints[payers - 1] += remainder;
                
                // 5. 0ì› í•œ ëª… ì¶”ê°€í•˜ê³  í•©ì¹˜ê¸°
                points = [0, ...distributedPoints];

            } else {
                // ì•½í•¨: Në¹µ ê¸°ì¤€ + ì•½ê°„ì˜ ë³€ë™
                // 1. ê¸°ë³¸ Në¹µ
                const basePoint = Math.floor(totalPoints / count);
                points.fill(basePoint);
                
                // 2. ì”ì—¬ í¬ì¸íŠ¸ ê³„ì‚°
                let currentSum = basePoint * count;
                let remainder = totalPoints - currentSum;
                
                // 3. ì”ì—¬ í¬ì¸íŠ¸ 1ì”© ë¶„ë°° (ì•ì—ì„œë¶€í„°)
                for(let i=0; i<remainder; i++) {
                    points[i]++;
                }
                
                // 4. ì•½ê°„ì˜ ëœë¤ ì„ê¸° (Jitter) - 'ì•½í•¨'ì´ë¯€ë¡œ ì†Œí­ ì´ë™
                // ë‘ ëª…ì„ ê³¨ë¼ í•œ ìª½ì—ì„œ 1~2ë‹¨ìœ„ë¥¼ ëºì–´ì„œ ë‹¤ë¥¸ ìª½ì— ì¤Œ
                const jitterCount = Math.floor(count / 2); // ì ˆë°˜ ì •ë„ íšŸìˆ˜ ë°˜ë³µ
                for(let k=0; k<jitterCount; k++) {
                    let giver = Math.floor(Math.random() * count);
                    let receiver = Math.floor(Math.random() * count);
                    
                    if (giver !== receiver && points[giver] > 0) {
                        // 1 ë‹¨ìœ„ ì´ë™
                        points[giver]--;
                        points[receiver]++;
                    }
                }
            }

            // í¬ì¸íŠ¸ -> ì‹¤ì œ ê¸ˆì•¡ ë³€í™˜
            return points.map(p => p * unit);
        }

        // ì‚¬ë‹¤ë¦¬ ê°€ë¡œì¤„ ìƒì„± ë¡œì§
        function generateLadder() {
            bridges = [];
            const steps = 15; // ì„¸ë¡œ êµ¬ê°„ ìˆ˜
            const stepHeight = (endY - startY) / steps;

            for (let i = 0; i < numPlayers - 1; i++) {
                for (let s = 1; s < steps - 1; s++) {
                    // 40% í™•ë¥ ë¡œ ë‹¤ë¦¬ ìƒì„±
                    if (Math.random() > 0.6) {
                        // ì œì•½ì¡°ê±´ ì²´í¬
                        const hasLeftBridge = bridges.some(b => b.col === i - 1 && b.step === s);
                        const hasTopBridge = bridges.some(b => b.col === i && b.step === s - 1);

                        if (!hasLeftBridge && !hasTopBridge) {
                            bridges.push({
                                col: i,
                                step: s,
                                y: startY + (s * stepHeight)
                            });
                            s++; // ë‹¤ë¦¬ ìƒì„± ì‹œ ë‹¤ìŒ ì¹¸ ê±´ë„ˆëœ€ (ê°„ê²© ìœ ì§€)
                        }
                    }
                }
            }
        }

        // ì‚¬ë‹¤ë¦¬ ê·¸ë¦¬ê¸°
        function drawLadder() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#ddd'; // ì—°í•œ íšŒìƒ‰ (ë°°ê²½ ë¼ì¸)

            const halfCol = columnWidth / 2;

            // ì„¸ë¡œì¤„ ê·¸ë¦¬ê¸° (ë°°ê²½)
            ctx.beginPath();
            for (let i = 0; i < numPlayers; i++) {
                const x = halfCol + (i * columnWidth);
                ctx.moveTo(x, startY);
                ctx.lineTo(x, endY);
            }
            ctx.stroke();

            // ê°€ë¡œì¤„ ê·¸ë¦¬ê¸° (ë°°ê²½)
            ctx.lineWidth = 4;
            ctx.beginPath();
            for (const bridge of bridges) {
                const x1 = halfCol + (bridge.col * columnWidth);
                const x2 = x1 + columnWidth;
                ctx.moveTo(x1, bridge.y);
                ctx.lineTo(x2, bridge.y);
            }
            ctx.stroke();
            
            // ë©”ì¸ ë¼ì¸ ë‹¤ì‹œ ê·¸ë¦¬ê¸° (ì§„í•˜ê²Œ)
             ctx.strokeStyle = '#374151'; // ì§„í•œ íšŒìƒ‰
             ctx.lineWidth = 2;
             // ... ë™ì¼ ë¡œì§ìœ¼ë¡œ ì–‡ê²Œ ë®ì–´ì“°ë©´ ê¹”ë”í•¨ (ìƒëµ ê°€ëŠ¥í•˜ë‚˜ í€„ë¦¬í‹° ìœ„í•´)
        }

        // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
        async function startLadder() {
            if (isAnimating) return;
            isAnimating = true;

            // ì°¸ê°€ì ì´ë¦„ ì €ì¥ (ë‹¤ì‹œí•˜ê¸° ëŒ€ë¹„)
            storedNames = [];
            for(let i=0; i<numPlayers; i++) {
                storedNames.push(document.getElementById(`name-${i}`).value);
            }

            // ê²°ê³¼ê°’ ê°€ì ¸ì˜¤ê¸°
            const moneyResults = [];
            const resultInputs = document.querySelectorAll('.result-input-group input');
            for (let input of resultInputs) {
                if (!input.value) {
                    alert("ê²°ê³¼ ê°’ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                    isAnimating = false;
                    return;
                }
                moneyResults.push(input.value);
            }

            // [ë³€ê²½ì ] ì‹œì‘ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ê°€ë¡œì¤„ ìƒì„± ë° ê·¸ë¦¬ê¸°
            generateLadder();
            drawLadder();

            const colors = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6'];
            
            results = []; 

            // ì• ë‹ˆë©”ì´ì…˜ ì§„í–‰
            let finishedCount = 0;

            // ìº”ë²„ìŠ¤ ì´ˆê¸°í™” (ê¸°ë³¸ ì‚¬ë‹¤ë¦¬ë§Œ ê·¸ë¦¼)
            // drawLadder(); // ìœ„ì—ì„œ ì´ë¯¸ ê·¸ë ¸ìœ¼ë¯€ë¡œ ìƒëµ

            for (let i = 0; i < numPlayers; i++) {
                const color = colors[i % colors.length];
                // ê° í”Œë ˆì´ì–´ë³„ë¡œ 200ms ê°„ê²© ë‘ê³  ì¶œë°œ
                animatePath(i, color, (finalIndex) => {
                    results.push({
                        name: storedNames[i],
                        result: moneyResults[finalIndex],
                        originalIndex: i
                    });
                    finishedCount++;
                    if (finishedCount === numPlayers) {
                        isAnimating = false;
                        setTimeout(showResults, 500);
                    }
                });
                await new Promise(r => setTimeout(r, 200)); 
            }
        }

        function animatePath(startIndex, color, callback) {
            let currentCol = startIndex;
            let currentX = (columnWidth / 2) + (currentCol * columnWidth);
            let currentY = startY;
            const speed = 4;
            
            ctx.strokeStyle = color;
            ctx.lineWidth = 4;

            function step() {
                ctx.beginPath();
                ctx.moveTo(currentX, currentY);

                let nextY = currentY + speed;
                
                // ì¢Œìš° ë‹¤ë¦¬ íƒìƒ‰
                let rightBridge = bridges.find(b => b.col === currentCol && Math.abs(b.y - currentY) < speed);
                let leftBridge = bridges.find(b => b.col === currentCol - 1 && Math.abs(b.y - currentY) < speed);

                if (rightBridge) {
                    ctx.lineTo(currentX, rightBridge.y); 
                    ctx.stroke();
                    currentY = rightBridge.y;
                    
                    ctx.beginPath();
                    ctx.moveTo(currentX, currentY);
                    currentX += columnWidth;
                    ctx.lineTo(currentX, currentY);
                    ctx.stroke();
                    
                    currentCol++;
                    currentY += speed; 
                    requestAnimationFrame(step);
                    return;
                } else if (leftBridge) {
                    ctx.lineTo(currentX, leftBridge.y);
                    ctx.stroke();
                    currentY = leftBridge.y;

                    ctx.beginPath();
                    ctx.moveTo(currentX, currentY);
                    currentX -= columnWidth;
                    ctx.lineTo(currentX, currentY);
                    ctx.stroke();

                    currentCol--;
                    currentY += speed;
                    requestAnimationFrame(step);
                    return;
                }

                if (nextY >= endY) {
                    ctx.lineTo(currentX, endY);
                    ctx.stroke();
                    callback(currentCol);
                } else {
                    ctx.lineTo(currentX, nextY);
                    ctx.stroke();
                    currentY = nextY;
                    requestAnimationFrame(step);
                }
            }
            step();
        }

        function showResults() {
            const list = document.getElementById('resultList');
            list.innerHTML = '';
            
            // ì´ë¦„ ìˆœì„œëŒ€ë¡œ ì •ë ¬í•´ì„œ ë³´ì—¬ì£¼ê¸°
            results.sort((a, b) => a.originalIndex - b.originalIndex);

            results.forEach(item => {
                const div = document.createElement('div');
                div.className = 'result-item';
                
                const val = parseInt(item.result.replace(/[^0-9]/g, '')) || 0;
                let styleClass = '';
                
                if (val === 0) styleClass = 'winner';
                else if (val >= parseInt(document.getElementById('totalAmount').value) / 2) styleClass = 'loser';

                div.innerHTML = `
                    <span>${item.name}</span>
                    <span class="${styleClass}">${item.result}ì›</span>
                `;
                list.appendChild(div);
            });

            document.getElementById('resultModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('resultModal').style.display = 'none';
        }

        // ë‹¤ì‹œí•˜ê¸° (Soft Reset)
        function resetToSetup() {
            // ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì´ë©´ ì¤‘ë‹¨ (ê°„ë‹¨íˆ flagë§Œ)
            isAnimating = false;
            
            // ì´ë¦„ ì €ì¥ (í˜„ì¬ ì…ë ¥ëœ ê°’ë“¤ì„ ë‹¤ì‹œ ì €ì¥)
            const nameInputs = document.querySelectorAll('.player-input-group input');
            storedNames = [];
            nameInputs.forEach(input => storedNames.push(input.value));

            // ëª¨ë‹¬ ë‹«ê¸°
            closeModal();

            // ë·° ì „í™˜
            document.getElementById('gameSection').style.display = 'none';
            document.getElementById('setupCard').style.display = 'block';
            
            // ìº”ë²„ìŠ¤ í´ë¦¬ì–´ (ì„ íƒì‚¬í•­, ì–´ì°¨í”¼ ë‹¤ì‹œ ê·¸ë¦´ ê²ƒì´ë¯€ë¡œ)
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

    </script>
</body>
</html>
